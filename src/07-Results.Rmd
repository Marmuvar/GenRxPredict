# Results  

In all studied conditions, models achieved significant accuracy (p < 0.001) on training sets.  Overall accuracy ranged from 0.76 to 1.0 vs. a prevalence of 0.5.  Although most models decreased in accuracy when analyzing the test sets, detection accuracy was significantly higher than prevalence in numerous cases.  

For the multiple administration route data, the baseline patent information was sufficient to predict generic competition before last patent expiry (Approved pre-last) using all three classification algorithms (Table \@ref(tab:msAMTab)).  The addition of packaging or ingredient information did not improve prediction accuracy.   The inclusion of patent use categories achieved similar accuracy for predicting competition before the last patent expiry with all three classification algorithms.  However, the boosted gradient method produced significant predictions for competition in all three categories with the inclusion of 60 patent use code topics (Table \@ref(tab:msBMTab)).  This includes a significant accuracy of `r scales::label_percent()(master_stats_B$Accuracy_test[25])` for competition before the first patent expiry.  Competition before first patent expiry and after last patent expiry could be predicted with boosted gradient methods with a combined data set of patents, use codes reduced to 60 topics, and packaging information (Table \@ref(tab:msCMTab)).  These models achieved `r scales::label_percent()(master_stats_C$Accuracy_test[7])` to `r scales::label_percent()(master_stats_C$Accuracy_test[9])` accuracy compared to the NIR of `r scales::label_percent()(master_stats_C$NIR_test[7])` to `r scales::label_percent()(master_stats_C$NIR_test[9])` (p< 0.05).  

\begin{singlespacing}
```{r msAMTab, include = TRUE}
proc_stat_table <- function(row_head, df) {
  cbind("features" = row_head, 
        select(df, 
               !c(len_train, len_test, Prevalence_test, NIR_train, 
                  Pval_train, Prevalence_train)
              )
        ) %>%
  mutate(rte_names = str_replace(rte_names, 
                                 "ORAL INJECTION INTRAVENOUS TOPICAL",
                                 "MULTI"),
         ct_period = str_replace(ct_period, "has_before_first", "pre-first"),
         ct_period = str_replace(ct_period, "has_before_last", "pre-last"),
         ct_period = str_replace(ct_period, "has_after_last", "post-last")) %>%
  rename(model = mod_names,
         Approved = ct_period,
         'Acc. Train' = Accuracy_train,
         'Acc. Test' = Accuracy_test, 
         NIR =  NIR_test,
         Pval = Pval_test)
} 
  
msa <- proc_stat_table(c(rep("a", 18), rep("b" , 18),  rep("c" , 18)),
                       master_stats_A)

msa %>%
  group_by(model, Approved, rte_names) %>%
  filter(rte_names == "MULTI") %>%
  ungroup() %>% 
  select(!rte_names) %>%
  kbl(booktabs = TRUE,
      caption = paste("Test Set Accuracy for Multiple Adminstration Routes ",
               "with Baseline Patent Information: "),
      position = "H") %>%
  collapse_rows(columns = 1:2) %>%
  footnote(alphabet = c("Base Patents", 
                        "Base and Ingredients", 
                        "Base and Packaging"))
```

```{r msBMTab, include = TRUE}
msb <- proc_stat_table(c(rep("a", 18), rep("b", 18),  rep("c", 18)
                         ),
                       master_stats_B
                       )
msb %>%
  group_by(model, Approved, rte_names) %>%
  filter(rte_names == "MULTI") %>%
  ungroup() %>% 
  select(!rte_names) %>%
  kbl(booktabs = TRUE, 
      caption = paste("Test Set Accuracy for Multiple Adminstration Routes ",
               "with Patent Use Codes: "),
      position = "H") %>%
  collapse_rows(columns = 1:2) %>%
  footnote(alphabet = c("10 Topics", 
                        "60 Topics", 
                        "120 Topics"))
```
```{r msCMTab, include = TRUE}
msc <- proc_stat_table(c(rep("a", 18), rep("b", 18),  rep("c", 18),
                        rep("d", 18)
                        ),
                       master_stats_C
                       )

msc %>%
  group_by(model, Approved, rte_names) %>%
  filter(rte_names == "MULTI") %>%
  ungroup() %>% 
  select(!rte_names) %>%
  kbl(booktabs = TRUE, 
      caption = paste("Test Set Accuracy for Multiple Adminstration Routes ",
              "with 60 Patent Use Codes, Packaging, and ",
              "Ingredient Features: "),
      longtable = TRUE,
      position = "H") %>%
  collapse_rows(columns = 1:2,
                longtable_clean_cut = TRUE,
                valign = "middle") %>%
  footnote(alphabet = c("Base Patents, Packaging, and Use Topics", 
                        "Patents, Ingredients, Packaging, and Use Topics", 
                        "Patents, Ingredients, and Use Topics",
                        "Patents, Ingredients, and Packaging" 
                        )
  ) %>%
  row_spec(27, extra_latex_after = "\\pagebreak[4]") %>%
  row_spec(36, extra_latex_after = "\\bottomrule") %>%
  kable_styling(latex_options = c("hold_position", "repeat_header"))
```
\end{singlespacing}

Using the baseline patent information to predict competition before last patent expiry, both the decision tree and boosted gradient methods assigned high weights to brand product application time prior to patent expiry, as shown in the feature importance graph (figure \@ref(fig:baseXGMulti)) and the decision tree (figure \@ref(fig:baseRpartMulti)).  From the decision tree, the largest classifiers based on a sum of terminal leafs are divided as:  

\begin{quote}

\bullet \;	No competition before last patent entry (51\%) when brand product was approved later than the mean time from last patent expiry;  

\bullet \;  Competition before last patent expiry (25\%) when the dosage form is a non-modified release tablet or is an injectable dosage form (injectable = 1) approved earlier than an arbitrary median point from last patent expiry (>=0.43);  

\bullet \; Competition before patent entry (16\%) when dosage form is not a tablet (tablet = 0) approved earlier than an arbitrary median point from last patent expiry (>=0.43)

\end{quote}

The boosted gradient method places high feature importance on timing before first and last patent expiry (brand_pre_first_pat, brand_pre_last_pat), while total patent count (pat_ct), total drug product patents (DP_ct) , total drug substance patents (DS_ct), and previous product count (brand_prev_prod_ct) are also among key features.  Looking at the SHAP plots, modified release tablets and capsules and general tablets and capsules suggest increased competition, while injectable, liquids and suspension, and dispersible dosage forms suggest a decreased likelihood of competition.  Higher values for brand approval time before first and last patent expiry and previous product count decrease the likelihood of competition, while higher numbers of patents increase the likelihood of competition.  

From a practical standpoint, the decision tree nodes and boosted gradient feature weights for brand approval relative to patent expiry and impact of patent count seem counter-intuitive.  They suggest that branded products entering the market further ahead of patent expiry are less prone to generic competition. One would assume that this would allow longer development times for generic competitors, giving them an opportunity to find a pathway to market.  In contast, considering that increased patent count decreases competition, the association of higher patent counts with less competition approximates industry behavior seen from the market analysis.  More patents are associated with longer generic approval times. 

The dosage forms highlighted from the SHAP plot bear further consideration.  The formulations for injectable dosage forms may have varying complexity, ranging from simple solutions to products that dissolve over multiple months.  Unlike most oral dosage products, delivery device engineering may need to accompany formulation development, and sterility assurance for the final product may be required [@lw10].  These features may inherently decrease competition.  In contrast, while modified release dosage forms have greater development and manufacturing complexity than general tablets and capsules, manufacturing and development capabilities for solid dosage forms are relatively common.  Within a model for multiple dosage forms, the polarity of these classifiers appears reasonable. 

\begin{singlespacing}
```{r}
min_max_scale <- function(df){
  
  min_df = sapply(select(df, where(is.numeric)), min) %>%
    list() %>%
    flatten() %>%
    as_tibble(.rows = length(df[[1]]))

  max_df = sapply(select(df, where(is.numeric)), max) %>%
    list() %>%
    flatten() %>%
    as_tibble(.rows = length(df[[1]]))

  range_df = max_df - min_df

  scale_df = ((df[colnames(min_df)] - min_df)/range_df) %>%
    cbind(select(df, !where(is.numeric)))
  return(scale_df)
}

```


```{r baseRpartMulti, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("Baseline RPART Model, Prediction of Competition Before ",
                "Last Patent Expiry, Multiple Administration Routes")

rpart.plot(master_model_A[[6]][[2]]) 

```

```{r baseXGMulti, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("Baseline Feature Importance for XGBoost Model, ",
                "Prediction of Competition before Last Patent Expiry, ",
                "Multiple Administration Routes")

bst <- xgb.Booster.complete(master_model_A[[6]][[8]])   
xgb.importance(model = bst) %>% 
xgb.ggplot.importance(top_n = 24) %>%
  print()
```
```{r baseXGMultiShap, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("SHAP Plot for XGBoost Model, ",
                "Prediction of Competition before Last Patent Expiry, ",
                "Multiple Administration Routes")

bst <- xgb.Booster.complete(master_model_A[[6]][[8]])   

trial <- prepare_trial(brands_w_pats_stats)  %>%
  select(bst$feature_names) %>%
        mutate(across(everything(), as.integer)) %>%
        min_max_scale() %>%
        as.matrix()
  xgb.ggplot.shap.summary(trial, model = bst, top_n = 24) + 
    theme(axis.text.y = element_text(size = 6),
          axis.text.x = element_text(size = 6),
          axis.title.y = element_text(size = 8),
          axis.title.x = element_text(size = 8),
          legend.title = element_text(size = 8)) +
   guides(color = guide_colorbar(title = "Feat Value")) +
   scale_color_viridis_c(na.value = "grey50", 
                        option = "magma",  
                        direction = -1, 
                        limits = c(-2, 10)) +    
   scale_y_continuous(name = "shap value")
```
\end{singlespacing}  
```{r topic_freq}
prod_ct <-brands_w_pats_stats %>%
  filter(admin_route %in% c("ORAL", "TOPICAL", "INTRAVENOUS", "INJECTION")) %>% 
  count()

filt_ct <- function(topic_term){
filter(use_codes, str_detect(Definition, topic_term))  %>% 
    inner_join(pats, by = c("Code" = "Use")) %>% 
    select(Code, app_nums) %>% 
    distinct()%>% 
    count()
}

topic_term_ct <- tibble("topic_term" = c("HIV", "DEMENTIA", "ALZHEIMER", "DEPRESSIVE", "INSOMNIA"), 
                       "ct" = unlist(sapply(topic_term, filt_ct)))

topic_term_ct <- mutate(topic_term_ct, pct =  ct/prod_ct$n)
```

Looking at competition before and after last patent expiry, the top three feature importance weights include time before first and last patent expiry and previous product count (figures \@ref(fig:base60XGMultiAl) and \@ref(fig:base60XGMultiBl)).  The predictor for competition before last patent expiry has a broader range of values associated with the features, and the drug substance, pediatric exclusivity, drug product, and total patent count are significant regressors.  Both sets include different sets of topic models.  This suggests that different therapeutic areas could have different tendencies towards generic competition.   

In the case of expected competition before first patent expiry, the results are more plausible.  Figure \@ref(fig:base60XGMultiBf) presents the feature importance plots for the boosted gradient model.  The extracted topic definitions are presented in Figure \@ref(fig:base60XGMultiBfTM).  Time before patent expiry and previous product count were also features used in predicting competition before last patent expiry.  In the top 4 topic models (T14, T37, T12, and T33), several prevalent disease states are noted (with no specific distinction)with reference to to the topic definitions: Alzheimers, dementia, HIV, depressive, and insomnia.  In context of brand dosage forms, HIV describes `r scales::label_percent(1)(topic_term_ct$pct[[1]])` of different brand products, while the other terms describe 2 to 3 % of products (Table \@ref(tab:topTerms).  Thus, the usage codes may discriminate edge cases more so than functioning as a general rule.  However, these details may improve overall model accuracy when present.  



\begin{singlespacing}
```{r topTerms, include = TRUE}
  topic_term_ct %>%
  mutate(percent = scales::label_percent(.1)(pct),
         pct = NULL) %>%
  kbl(booktabs = TRUE, 
      caption = paste("Key Topic Term Frequency in Usage Codes "),
      position = "H")
```
\end{singlespacing}  


```{r base60XGMultiAl, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("Feature Importance for XGBoost Model with Baseline Patents ",
              "and 60 Use Code Topics: ",
                "Prediction of Competition after Last Patent Expiry, ",
                "Multiple Administration Routes")

bst <- xgb.Booster.complete(master_model_B[[6]][[27]])   
xgb.importance(model = bst) %>% 
xgb.ggplot.importance(top_n = 24) %>%
  print()
```

```{r base60XGMultiBl, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("Feature Importance for XGBoost Model with Baseline Patents ",
              "and 60 Use Code Topics: ",
                "Prediction of Competition before Last Patent Expiry, ",
                "Multiple Administration Routes")

bst <- xgb.Booster.complete(master_model_B[[6]][[26]])   
xgb.importance(model = bst) %>% 
xgb.ggplot.importance(top_n = 24) %>%
  print()
```

\begin{singlespacing}
```{r base60XGMultiBf, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("Feature Importance for XGBoost Model with Baseline Patents ",
              "and 60 Use Code Topics: ",
                "Prediction of Competition before First Patent Expiry, ",
                "Multiple Administration Routes")

bst <- xgb.Booster.complete(master_model_B[[6]][[25]])   
xgb.importance(model = bst) %>% 
xgb.ggplot.importance(top_n = 24) %>%
  print()
```

```{r base60XGMultiBfTM, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 8, fig.width = 6}
h_cap = paste("Topic Descriptions from XGBoost Model with Baseline Patents ",
              "and 60 Use Code Topics ",
                "to Predict Competition before First Patent Expiry, ",
                "Multiple Administration Routes: ",
              "Specific treatements and broad thereapeutic ",
              "areas represent a reasonable set of classifiers")

plot(master_model_B$topics[[25]], text.cex = 0.8) 
```
\end{singlespacing}

```{r topic_freqPack}
topic_term2_ct <- tibble("topic_term" = c("INTERCOURSE", "KERATOSES", "ADJUNCTIVE", "THERAPY", "BACTERIA"), 
                       "ct" = unlist(sapply(topic_term, filt_ct)))

topic_term2_ct <- mutate(topic_term2_ct, pct =  ct/prod_ct$n)
```

When packaging and usage information are added to the boosted gradient model, additional weight is given to "injectable" and "modified release" dosage forms (figure \@ref(fig:basePackUseXGMultiFIBf)).  Selected terms from the usage codes are also informative (figure \@ref(fig:basePack60XGMultiBfTM)) and are different from those chosen withot the packaging components.  In the top 4 topic models (T14, T2, T6, and T16), a mixture of common terms and disease states are noted with reference to to the topic definitions: intercourse, keratoses, adjunctive, therapy, and bacteria.  In context of brand dosage forms, bacteria and therapy describe 10 to 31\% of different brand products, while the other terms describe 1 to 5\% of products (Table \@ref(tab:topTerms)).  Again, the usage codes may discriminate edge cases more so than functioning as a general rule.  


\begin{singlespacing}
```{r basePackUseXGMultiFIBf, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("Feaature Importance Plot for XGBoost Model with Baseline Patents, 60 Usage Codes",
                "and Packaging for ",
                "Prediction of Competition before Last Patent Expiry, ",
                "Multiple Administration Routes")

bst <- xgb.Booster.complete(master_model_C[[6]][[7]])
xgb.importance(model = bst) %>%
xgb.ggplot.importance(top_n = 24) %>%
  print()
```

```{r basePack60XGMultiBfTM, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 8, fig.width = 6}
h_cap = paste("Topics Descriptions from XGBoost Model with Baseline Patents, ",
              "Packaging Components, and 60 Use Code Topics to ",
                "Predict Competition before First Patent Expiry, ",
                "Multiple Administration Routes: ")

plot(master_model_C$topics[[7]], text.cex = 0.8) 
```


\end{singlespacing}

Because products for different routes of administration have different ingredient compositions, limiting the data set to only orally administered products was hypothesized to produce more accurate models.  However, model accuracy appeared to be similar to the multiple administration route date set in most cases (Tables \@ref(tab:msAOTab), \@ref(tab:msBOTab), and \@ref(tab:msCOTab).  Using the baseline patent information alone, generic competition  before the last patent expiry was predicted with significant accuracy using all three methods.  For competition before first patent expiry, the base features with packaging information was useful for the SVM model to achieve significant accuracy.  Competition before the first patent expiry as also predicted using the boosted gradient model with base patent features and ingredient information.  Inclusion of patent use codes decreased model accuracy for svm and decision tree algorithms.  However, these features did not affect performance for the boosted gradient algorithm.   Combinations of base, usage codes, ingredients, and packaging components produced accurate models only for prediction of competition after last patent expiry.  

\begin{singlespacing}
```{r msAOTab, include = TRUE}
msa <- proc_stat_table(c(rep("a", 18), rep("b" , 18),  rep("c" , 18)),
                       master_stats_A)

msa %>%
  group_by(model, Approved, rte_names) %>%
  filter(rte_names == "ORAL") %>%
  ungroup() %>% 
  select(!rte_names) %>%
  kbl(booktabs = TRUE,       
      caption = paste("Test Set Accuracy for Oral Adminstration Routes ",
               "with Baseline Patent Information: "),
      position = "H") %>%  
  collapse_rows(columns = 1:2) %>%
  footnote(alphabet = c("Base Patents", 
                        "Base and Ingredients",
                        "Base and Packaging"))
```
```{r msBOTab, include = TRUE}
msb <- proc_stat_table(c(rep("a", 18), rep("b", 18),  rep("c", 18)),
                       master_stats_B
                       )

msb %>%
  group_by(model, Approved, rte_names) %>%
  filter(rte_names == "ORAL") %>%
  ungroup() %>% 
  select(!rte_names) %>%
  kbl(booktabs = TRUE, 
      caption = paste("Test Set Accuracy for Oral Adminstration Routes ",
               "with Base Patents and Patent Use Codes: "),
      position = "H") %>%
  collapse_rows(columns = 1:2) %>%
  footnote(alphabet = c("10 Topics", 
                        "60 Topics", 
                        "120 Topics"))
```
```{r msCOTab, include = TRUE}
msc <- proc_stat_table(c(rep("a", 18), rep("b", 18),  rep("c", 18), rep("d", 18)
                         ),
                       master_stats_C
                       )

msc %>%
  group_by(model, Approved, rte_names) %>%
  filter(rte_names == "ORAL") %>%
  ungroup() %>% 
  select(!rte_names) %>%
  kbl(booktabs = TRUE, 
      caption = paste("Test Set Accuracy for Oral Adminstration Routes ",
              "with 60 Patent Use Codes, Packaging, and ",
              "Ingredient Features"),
      longtable = TRUE,
      position = "H") %>%
  collapse_rows(columns = 1:2,
                longtable_clean_cut = TRUE,
                valign = "middle") %>%
  footnote(alphabet = c("Base Patents, Packaging, and Use Topics", 
                        "Base Patents, Ingredients, Packaging, and Use Topics", 
                        "Base Patents, Ingredients, and Use Topics",
                        "Base Patents, Ingredients, and Packaging" 
                        )
  ) %>%
  row_spec(27, extra_latex_after = "\\pagebreak[4]") %>%
  row_spec(36, extra_latex_after = "\\bottomrule") %>%
  kable_styling(latex_options = c("repeat_header"))
```
```{r msDOTab, include = TRUE}
msd <- proc_stat_table(c(rep("a", 18), rep("b" , 18),  rep("c" , 18)),
                       master_stats_d)

msd %>%
  group_by(model, Approved, rte_names) %>%
  filter(rte_names == "ORAL") %>%
  ungroup() %>% 
  select(!rte_names) %>%
  kbl(booktabs = TRUE, 
      caption = paste("Test Set Accuracy for Oral Adminstration Routes ",
              "with 10 Patent Use Codes, Packaging, and ",
              "Ingredient Features: "),
      position = "H") %>%
  collapse_rows(columns = 1:2) %>%
  footnote(alphabet = c("Base Patents, Packaging, and Use Topics", 
                        "Base Patents, Ingredients, Packaging, and Use Topics", 
                        "Base Patents, Ingredients, and Use Topics"
                        )
  )
```
\end{singlespacing} 

Unlike the set of multiple administration routes, the oral administration route alone did not have a single combination of predictors with significant accuracy for all three competition categories.  Considering the prediction for competition before last patent expiry in the oral route of administration, the rpart decision tree (Figure \@ref(fig:baseRpartOralBl)) has a complicated mixture of rules assigned to the timing of product approval before first and last patent expiry. Exploring the decision tree, the rules seem to create numerous fine cutoff points for similar categories.  In one large category, drug products approved much earlier than an arbitrary median with relatively few general patents that do not apply to drug substances explains 27\% of the categories without expected generic competition.  On the opposite side of the decision tree, a product with few patents approved closer to the first patent expiration date corresponds to the likely entrance of generic competition.  However, the feature importance seems similar to both the boosted gradient tree (Figure \@ref(fig:baseXGOralFI)) and the decision tree for the multiple-administration routes.  

\begin{singlespacing}
```{r baseRpartOralBl, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 8}
h_cap = paste("Baseline RPART Model, Prediction of Competition Before ",
                "Last Patent Expiry, Oral Administration Routes")

rpart.plot(master_model_A[[6]][[5]], tweak = 1) 
```

```{r baseXGOralFI, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("Baseline Feature Importance for XGBoost Model, ",
                "Prediction of Competition before Last Patent Expiry, ",
                "Oral Administration Routes")

bst <- xgb.Booster.complete(master_model_A[[6]][[11]])   
xgb.importance(model = bst) %>% 
xgb.ggplot.importance(top_n = 24) 
```
\end{singlespacing}

For the oral administration products with competition before the first patent expiry, the boosted gradient model used features from the base set and  ingredients to produce a model with significant accuracy.   The key features selected for competition after last patent expiry appear similar, albeit weighted differently than, those selected for competition before last patent expiry (Figures \@ref(fig:baseIngXGOralFir), \@ref(fig:baseIngXGOralFirShap), and \@ref(fig:baseIngXGOralLaShap)).  

\begin{singlespacing}  
```{r baseIngXGOralFir, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 11}
h_cap = paste("Feature Importance for XGBoost Model using Patent and ",
                "Ingredient Features for Prediction of Competition before ",
                "First Patent Expiry, Oral Administration Routes")

bst <- xgb.Booster.complete(master_model_A[[6]][[28]])   
xgb.importance(model = bst) %>% 
xgb.ggplot.importance(top_n = 24) + 
theme(axis.text.y = element_text(size = 6),
      axis.text.x = element_text(size = 6)) 
```
```{r baseIngXGOralFirShap, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("SHAP Plot for XGBoost Model with Baseline Patents and Ingredients, ",
                "Prediction of Competition before first Patent Expiry, ",
                "Oral Administration Routes")

bst <- xgb.Booster.complete(master_model_A[[6]][[28]])   

trial <- brands_w_pats_stats %>%
  inner_join(ingredients_wide, by = c("app_nums_brand" = "app_nums")) %>%
  prepare_trial()  %>%
  select(bst$feature_names) %>%
        mutate(across(everything(), as.integer)) %>%
        min_max_scale() %>%
        as.matrix()
  xgb.ggplot.shap.summary(trial, model = bst, top_n = 24) + 
    theme(          axis.text.y = element_text(size = 6),
                   axis.text.x = element_text(size = 6),
          axis.title.y = element_text(size = 8),
          axis.title.x = element_text(size = 8),
          legend.title = element_text(size = 8)) +
   guides(color = guide_colorbar(title = "Feat Value")) +
   scale_color_viridis_c(na.value = "grey50", 
                          option = "plasma",  
                          direction = -1, 
                          limits = c(-2, 10)) +
   scale_y_continuous(name = "shap value")
```

```{r baseIngXGOralLaShap, eval.after = c("fig.cap"), fig.cap = h_cap, include = TRUE, fig.height = 6, fig.width = 6}
h_cap = paste("SHAP Plot for XGBoost Model with Baseline Patents and Ingredients, ",
                "Prediction of Competition before first Patent Expiry, ",
                "Oral Administration Routes")

bst <- xgb.Booster.complete(master_model_A[[6]][[30]])   

trial <- brands_w_pats_stats %>%
  inner_join(ingredients_wide, by = c("app_nums_brand" = "app_nums")) %>%
  prepare_trial()  %>%
  select(bst$feature_names) %>%
        mutate(across(everything(), as.integer)) %>%
        min_max_scale() %>%
        as.matrix()
  xgb.ggplot.shap.summary(trial, model = bst, top_n = 24) + 
    theme(          axis.text.y = element_text(size = 6),
                   axis.text.x = element_text(size = 6),
          axis.title.y = element_text(size = 8),
          axis.title.x = element_text(size = 8),
          legend.title = element_text(size = 8)) +
   guides(color = guide_colorbar(title = "Feat Value")) +
   scale_color_viridis_c(na.value = "grey50", 
                          option = "plasma",  
                          direction = -1, 
                          limits = c(-2, 10)) +
   scale_y_continuous(name = "shap value")
```

\end{singlespacing}